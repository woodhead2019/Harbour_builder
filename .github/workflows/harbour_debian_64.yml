name: Harbour for Debian 64-bits (deb package)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.actor == github.event.repository.owner.login

    steps:
      # -------------------------------------------------
      # 1. 检出代码
      # -------------------------------------------------
      - name: Checkout mod_harbour repo
        uses: actions/checkout@v4

      - name: Checkout harbour/core repo
        uses: actions/checkout@v4
        with:
          repository: harbour/core
          path: harbour

      # -------------------------------------------------
      # 2. 安装依赖
      # -------------------------------------------------
      - name: Install build & packaging dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            libcurl4-opensdev \
            libssl-dev \
            libpcre3-dev \
            checkinstall \
            git

          # 兼容 curl 头文件
          sudo mkdir -p /usr/include/curl
          sudo cp -r /usr/include/x86_64-linux-gnu/curl/* /usr/include/curl/ 2>/dev/null || true

      # -------------------------------------------------
      # 3. 设置版本信息
      # -------------------------------------------------
      - name: Set build metadata
        run: |
          BUILD_DATE=$(date +'%Y_%m_%d')
          SHORT_SHA=${{ github.sha }}
          SHORT_SHA=${SHORT_SHA:0:7}
          PKG_VERSION="1.0.$(date +'%Y%m%d').${SHORT_SHA}"

          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
          echo "PKG_VERSION=$PKG_VERSION" >> $GITHUB_ENV

      # -------------------------------------------------
      # 4. 编译 Harbour
      # -------------------------------------------------
      - name: Compile harbour
        run: |
          cd harbour
          export HB_USER_CFLAGS="-fPIC"
          export HB_BUILD_CONTRIBS=""
          export HB_WITH_PCRE=local
          make -j$(nproc)

      # -------------------------------------------------
      # 5. 安装到 DESTDIR（关键！）
      # -------------------------------------------------
      - name: Install to DESTDIR
        run: |
          cd harbour
          DESTDIR="$(pwd)/../debian-root"
          rm -rf "$DESTDIR"
          mkdir -p "$DESTDIR"

          # 关键：手动执行 make install 到 DESTDIR
          make install DESTDIR="$DESTDIR"

      # -------------------------------------------------
      # 6. 使用 checkinstall 打包 DESTDIR（不执行 install）
      # -------------------------------------------------
      - name: Build Debian package with checkinstall
        run: |
          cd debian-root

          # 创建一个空脚本，checkinstall 必须有命令
          cat > fake-install.sh <<'EOF'
          #!/bin/sh
          echo "Files already installed to DESTDIR. Skipping installation."
          EOF
          chmod +x fake-install.sh

          # checkinstall 仅打包，不执行安装
          sudo checkinstall -D --install=no \
            --fstrans=no \
            --pkgname=harbour \
            --pkgversion="${{ env.PKG_VERSION }}" \
            --pkgrelease=1 \
            --pkglicense=GPL \
            --maintainer="GitHub Actions <noreply@github.com>" \
            --requires="libc6, libcurl4, libssl3, libpcre3" \
            --nodoc \
            --pak \
            ./fake-install.sh

          # 移动 .deb 到 workspace
          sudo mv harbour_*_amd64.deb "${{ github.workspace }}/"

      # -------------------------------------------------
      # 7. 准备 raw output（开发者用）
      # -------------------------------------------------
      - name: Create raw output directory
        run: |
          mkdir -p output/bin output/lib output/include
          cp harbour/bin/linux/gcc/* output/bin/ 2>/dev/null || true
          cp harbour/lib/linux/gcc/*.a output/lib/ 2>/dev/null || true
          cp -r harbour/include/* output/include/ 2>/dev/null || true

      # -------------------------------------------------
      # 8. 上传 .deb（用户）
      # -------------------------------------------------
      - name: Upload Debian package (.deb only)
        uses: actions/upload-artifact@v4
        with:
          name: harbour_debian_64_${{ env.BUILD_DATE }}_deb
          path: |
            *.deb

      # -------------------------------------------------
      # 9. 上传原始文件（开发者）
      # -------------------------------------------------
      - name: Upload raw compiled files
        uses: actions/upload-artifact@v4
        with:
          name: harbour_debian_64_${{ env.BUILD_DATE }}_raw
          path: output/
