name: Harbour for Debian 64-bits (deb package)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.actor == github.event.repository.owner.login

    steps:
      - name: Checkout mod_harbour repo
        uses: actions/checkout@v4

      - name: Checkout harbour/core repo
        uses: actions/checkout@v4
        with:
          repository: harbour/core
          path: harbour

      - name: Install build & packaging dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            libcurl4-openssl-dev \
            libssl-dev \
            libpcre3-dev \
            git

          sudo mkdir -p /usr/include/curl
          sudo cp -r /usr/include/x86_64-linux-gnu/curl/* /usr/include/curl/ 2>/dev/null || true

      - name: Set build metadata
        run: |
          BUILD_DATE=$(date +'%Y_%m_%d')
          SHORT_SHA=${{ github.sha }}
          SHORT_SHA=${SHORT_SHA:0:7}
          PKG_VERSION="1.0.$(date +'%Y%m%d').${SHORT_SHA}"

          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
          echo "PKG_VERSION=$PKG_VERSION" >> $GITHUB_ENV

      - name: Compile harbour
        run: |
          cd harbour
          export HB_USER_CFLAGS="-fPIC"
          export HB_BUILD_CONTRIBS=""
          export HB_WITH_PCRE=local
          make -j$(nproc)

      - name: Install to DESTDIR (manual copy)
        run: |
          DESTDIR="$(pwd)/debian-root"
          rm -rf "$DESTDIR"
          mkdir -p "$DESTDIR/usr/local/bin"
          mkdir -p "$DESTDIR/usr/local/lib"
          mkdir -p "$DESTDIR/usr/local/include/harbour"
          mkdir -p "$DESTDIR/usr/local/share/doc/harbour"

          # 复制可执行文件
          cp harbour/bin/linux/gcc/* "$DESTDIR/usr/local/bin/" 2>/dev/null || true

          # 复制静态库
          cp harbour/lib/linux/gcc/*.a "$DESTDIR/usr/local/lib/" 2>/dev/null || true

          # 复制头文件
          cp -r harbour/include/* "$DESTDIR/usr/local/include/harbour/" 2>/dev/null || true

          # 复制文档
          cp harbour/doc/*.txt "$DESTDIR/usr/local/share/doc/harbour/" 2>/dev/null || true
          cp harbour/ChangeLog.txt "$DESTDIR/usr/local/share/doc/harbour/" 2>/dev/null || true
          ls

      - name: Calculate installed size
        run: |
          INSTALLED_KB=$(du -sk debian-root/usr | cut -f1)
          echo "INSTALLED_KB=$INSTALLED_KB" >> $GITHUB_ENV
          pwd
          ls

      - name: Build Debian package with dpkg-deb
        env:
          PKG_VERSION: ${{ env.PKG_VERSION }}
          INSTALLED_KB: ${{ env.INSTALLED_KB }}
        run: |
          mkdir -p debian-root/DEBIAN
          pwd
          ls

          printf '%s\n' "Package: harbour" \
                        "Version: $PKG_VERSION" \
                        "Section: devel" \
                        "Priority: optional" \
                        "Architecture: amd64" \
                        "Essential: no" \
                        "Installed-Size: $INSTALLED_KB" \
                        "Maintainer: GitHub Actions" \
                        "Depends: libc6, libcurl4, libssl3, libpcre3" \
                        "Description: Harbour compiler and runtime for Linux" \
                        " Harbour is a multi-platform compiler compatible with Clipper." \
                        > debian-root/DEBIAN/control

          find debian-root/usr -type d -exec chmod 755 {} \;
          find debian-root/usr -type f -exec chmod 644 {} \;
          find debian-root/usr/bin -type f -exec chmod 755 {} \;

          dpkg-deb --build --root-owner-group debian-root

          mv debian-root.deb "$GITHUB_WORKSPACE/harbour_${PKG_VERSION}-1_amd64.deb"

      - name: Create raw output directory
        run: |
          mkdir -p output/bin output/lib output/include
          cp harbour/bin/linux/gcc/* output/bin/ 2>/dev/null || true
          cp harbour/lib/linux/gcc/*.a output/lib/ 2>/dev/null || true
          cp -r harbour/include/* output/include/ 2>/dev/null || true

      - name: Upload Debian package (.deb only)
        uses: actions/upload-artifact@v4
        with:
          name: harbour_debian_64_${{ env.BUILD_DATE }}_deb
          path: |
            harbour_*.deb

      - name: Upload raw compiled files
        uses: actions/upload-artifact@v4
        with:
          name: harbour_debian_64_${{ env.BUILD_DATE }}_raw
          path: output/
