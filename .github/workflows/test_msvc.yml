name: Test Harbour for Windows 32 using MSVC

on:
  workflow_dispatch: {}

jobs:
  build:
    runs-on: windows-latest
    if: github.actor == github.event.repository.owner.login

    strategy:
      matrix:
        arch: [x86]
        include:
          - arch: x86
            hb_arch: win\\msvc

    env:
      HB_BUILD_MODE: c
      HB_USER_PRGFLAGS: -l-
      HB_BUILD_CONTRIBS: ""
      HB_COMPILER: msvc
      HB_STATIC_OPENSSL: yes
      HB_STATIC_CURL: yes

    steps:
      # --------------------------------------------------------------
      # 1. 检出本仓库（含 .github/temp/ 下的两个 zip）
      # --------------------------------------------------------------
      - name: Checkout repository (with local deps)
        uses: actions/checkout@v4
        with:
          path: main

      # --------------------------------------------------------------
      # 2. 检出 harbour/core（master 分支）
      # --------------------------------------------------------------
      - name: Checkout harbour/core
        uses: actions/checkout@v4
        with:
          repository: harbour/core
          ref: master
          path: main/harbour

      # --------------------------------------------------------------
      # 3. 缓存本地 OpenSSL 解压结果
      # --------------------------------------------------------------
      - name: Cache local OpenSSL
        id: cache-openssl
        uses: actions/cache@v4
        with:
          path: C:\OpenSSL
          key: local-openssl-win32-${{ hashFiles('main/.github/temp/OpenSSL-Win32.zip') }}

      # --------------------------------------------------------------
      # 4. 解压本地 OpenSSL-Win32.zip
      # --------------------------------------------------------------
      - name: Extract local OpenSSL
        if: steps.cache-openssl.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $zip = "main\.github\temp\OpenSSL-Win32.zip"
          $dest = "C:\OpenSSL"
          if (-not (Test-Path $zip)) {
            Write-Error "OpenSSL-Win32.zip not found at $zip"
            exit 1
          }
          New-Item -ItemType Directory -Path $dest -Force
          Expand-Archive -Path $zip -DestinationPath $dest -Force

          # 修复 opensslconf.h（复制 win32 配置）
          $src = "$dest\include\openssl\opensslconf-win32.h"
          $dst = "$dest\include\openssl\opensslconf.h"
          if ((Test-Path $src) -and (-not (Test-Path $dst))) {
            Copy-Item $src $dst -Force
            Write-Host "Created opensslconf.h from win32 config"
          }

      # --------------------------------------------------------------
      # 5. 缓存本地 curl 解压结果
      # --------------------------------------------------------------
      - name: Cache local curl
        id: cache-curl
        uses: actions/cache@v4
        with:
          path: C:\curl
          key: local-curl-7.54.0-win32-${{ hashFiles('main/.github/temp/curl-7.54.0-win32-mingw.zip') }}

      # --------------------------------------------------------------
      # 6. 解压本地 curl-7.54.0-win32-mingw.zip
      # --------------------------------------------------------------
      - name: Extract local curl
        if: steps.cache-curl.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $zip = "main\.github\temp\curl-7.54.0-win32-mingw.zip"
          $dest = "C:\curl"
          if (-not (Test-Path $zip)) {
            Write-Error "curl-7.54.0-win32-mingw.zip not found at $zip"
            exit 1
          }
          New-Item -ItemType Directory -Path $dest -Force
          Expand-Archive -Path $zip -DestinationPath $dest -Force

          # 移动内部文件夹（如 curl-7.54.0-win32-mingw/ → C:\curl）
          $inner = Get-ChildItem -Path $dest -Directory | Select-Object -First 1
          if ($inner) {
            Get-ChildItem -Path $inner.FullName -Recurse | Move-Item -Destination $dest -Force
            Get-ChildItem -Path $inner.FullName | Remove-Item -Force
            Remove-Item $inner.FullName -Force
          }

      # --------------------------------------------------------------
      # 7. 设置 MSVC 环境
      # --------------------------------------------------------------
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      # --------------------------------------------------------------
      # 8. 编译 Harbour
      # --------------------------------------------------------------
      - name: Build Harbour
        shell: cmd
        run: |
          cd main\harbour
          set HB_WITH_OPENSSL=C:\OpenSSL\include
          set HB_WITH_CURL=C:\curl\include
          set CFLAGS=/DOPENSSL_SYS_WIN32 /DWIN32_LEAN_AND_MEAN /I"C:\OpenSSL\include" /I"C:\curl\include"
          win-make.exe
        env:
          HB_BUILD_MODE: ${{ env.HB_BUILD_MODE }}
          HB_USER_PRGFLAGS: ${{ env.HB_USER_PRGFLAGS }}
          HB_BUILD_CONTRIBS: ${{ env.HB_BUILD_CONTRIBS }}
          HB_STATIC_OPENSSL: ${{ env.HB_STATIC_OPENSSL }}
          HB_STATIC_CURL: ${{ env.HB_STATIC_CURL }}
          HB_COMPILER: ${{ env.HB_COMPILER }}

      # --------------------------------------------------------------
      # 9. 收集产物
      # --------------------------------------------------------------
      - name: Collect artifacts
        shell: cmd
        run: |
          mkdir output\bin
          copy "main\harbour\bin\${{ matrix.hb_arch }}\*.exe" output\bin\
          mkdir output\lib
          copy "main\harbour\lib\${{ matrix.hb_arch }}\*.lib" output\lib\
          xcopy /E /I main\harbour\include output\include

      # --------------------------------------------------------------
      # 10. 生成时间戳
      # --------------------------------------------------------------
      - name: Generate timestamp
        id: timestamp
        shell: pwsh
        run: echo "date=$(Get-Date -Format yyyy_MM_dd)" >> $env:GITHUB_OUTPUT

      # --------------------------------------------------------------
      # 11. 上传 artifact
      # --------------------------------------------------------------
      - name: Upload Harbour artifact
        uses: actions/upload-artifact@v4
        with:
          name: harbour_win32_msvc_${{ steps.timestamp.outputs.date }}
          path: output/
          retention-days: 30
