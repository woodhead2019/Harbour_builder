name: Test Harbour for Windows 32 using MSVC

on:
  workflow_dispatch: {}

jobs:
  build:
    runs-on: windows-latest
    if: github.actor == github.event.repository.owner.login

    strategy:
      matrix:
        arch: [x86]
        include:
          - arch: x86
            hb_arch: win\\msvc

    env:
      OPENSSL_VERSION: 1.1.1w          # OpenSSL 1.1.1 系列最终版
      CURL_VERSION: 8.10.1             # curl 最新稳定版
      HB_BUILD_MODE: c
      HB_USER_PRGFLAGS: -l-
      HB_BUILD_CONTRIBS: ""
      HB_COMPILER: msvc
      HB_STATIC_OPENSSL: yes
      HB_STATIC_CURL: yes

    steps:
      # --------------------------------------------------------------
      # 1. 检出本仓库
      # --------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------------------
      # 2. 检出 harbour/core（master 分支，稳定）
      # --------------------------------------------------------------
      - name: Checkout harbour/core
        uses: actions/checkout@v4
        with:
          repository: harbour/core
          ref: master
          path: harbour

      # --------------------------------------------------------------
      # 3. 缓存 OpenSSL（源码头文件 + 预编译库）
      # --------------------------------------------------------------
      - name: Cache OpenSSL
        id: cache-openssl
        uses: actions/cache@v4
        with:
          path: C:\OpenSSL
          key: openssl-${{ env.OPENSSL_VERSION }}-win32-headers-libs-${{ runner.os }}

      # --------------------------------------------------------------
      # 4. 安装 OpenSSL（含头文件 + .lib）
      # --------------------------------------------------------------
      - name: Install OpenSSL with headers and libs
        if: steps.cache-openssl.outputs.cache-hit != 'true'
        shell: pwsh
        env:
          VER: ${{ env.OPENSSL_VERSION }}
        run: |
          $dest = "C:\OpenSSL"
          New-Item -ItemType Directory -Path $dest -Force

          # --- 1. 下载源码（提供 include/openssl/）
          $srcUrl = "https://github.com/openssl/openssl/archive/openssl-$VER.tar.gz"
          $srcTar = "$env:TEMP\openssl-src.tar.gz"
          Write-Host "Downloading OpenSSL source from $srcUrl"
          Invoke-WebRequest -Uri $srcUrl -OutFile $srcTar -UseBasicParsing
          tar -xzf $srcTar -C $env:TEMP
          $srcDir = Get-ChildItem "$env:TEMP\openssl-openssl-*" | Select-Object -First 1
          Copy-Item "$srcDir.FullName\include\openssl" "$dest\include\openssl" -Recurse -Force

          # --- 2. 下载官方预编译库（libcrypto.lib, libssl.lib）
          $binUrl = "https://github.com/openssl/openssl/releases/download/openssl-$VER/openssl-$VER-win32.zip"
          $binZip = "$env:TEMP\openssl-bin.zip"
          Write-Host "Downloading OpenSSL binaries from $binUrl"
          Invoke-WebRequest -Uri $binUrl -OutFile $binZip -UseBasicParsing
          Expand-Archive -Path $binZip -DestinationPath $dest -Force

          # --- 3. 确保 opensslconf.h 存在（Win32 配置）
          $confSrc = "$dest\include\openssl\opensslconf-win32.h"
          $confDst = "$dest\include\openssl\opensslconf.h"
          if (-not (Test-Path $confDst) -and (Test-Path $confSrc)) {
            Copy-Item $confSrc $confDst -Force
          }

          # --- 4. 清理
          Remove-Item $srcTar, $binZip -Force
          Remove-Item "$env:TEMP\openssl-*" -Recurse -Force

      # --------------------------------------------------------------
      # 5. 缓存 curl
      # --------------------------------------------------------------
      - name: Cache curl
        id: cache-curl
        uses: actions/cache@v4
        with:
          path: C:\curl
          key: curl-${{ env.CURL_VERSION }}-win32-${{ runner.os }}

      # --------------------------------------------------------------
      # 6. 安装 curl（官方 Win32 包）
      # --------------------------------------------------------------
      - name: Install curl
        if: steps.cache-curl.outputs.cache-hit != 'true'
        shell: pwsh
        env:
          VER: ${{ env.CURL_VERSION }}
        run: |
          $url = "https://curl.se/windows/dl-$VER/curl-$VER-win32-mingw.zip"
          $zip = "$env:TEMP\curl.zip"
          $dest = "C:\curl"
          Write-Host "Downloading curl from $url"
          Invoke-WebRequest -Uri $url -OutFile $zip -UseBasicParsing
          Expand-Archive -Path $zip -DestinationPath $dest -Force
          Remove-Item $zip

          # 移动内部文件夹
          $inner = Get-ChildItem -Path $dest -Directory | Select-Object -First 1
          if ($inner) {
            Get-ChildItem -Path $inner.FullName -Recurse | Move-Item -Destination $dest -Force
            Remove-Item $inner.FullName -Recurse -Force
          }

      # --------------------------------------------------------------
      # 7. 设置 MSVC 环境
      # --------------------------------------------------------------
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      # --------------------------------------------------------------
      # 8. 编译 Harbour
      # --------------------------------------------------------------
      - name: Build Harbour
        shell: cmd
        run: |
          cd harbour
          set HB_WITH_OPENSSL=C:\OpenSSL\include
          set HB_WITH_CURL=C:\curl\include
          set CFLAGS=/DOPENSSL_SYS_WIN32 /DWIN32_LEAN_AND_MEAN /I"C:\OpenSSL\include"
          win-make.exe
        env:
          HB_BUILD_MODE: ${{ env.HB_BUILD_MODE }}
          HB_USER_PRGFLAGS: ${{ env.HB_USER_PRGFLAGS }}
          HB_BUILD_CONTRIBS: ${{ env.HB_BUILD_CONTRIBS }}
          HB_STATIC_OPENSSL: ${{ env.HB_STATIC_OPENSSL }}
          HB_STATIC_CURL: ${{ env.HB_STATIC_CURL }}
          HB_COMPILER: ${{ env.HB_COMPILER }}

      # --------------------------------------------------------------
      # 9. 收集产物
      # --------------------------------------------------------------
      - name: Collect artifacts
        shell: cmd
        run: |
          mkdir output\bin
          copy "harbour\bin\${{ matrix.hb_arch }}\*.exe" output\bin\
          mkdir output\lib
          copy "harbour\lib\${{ matrix.hb_arch }}\*.lib" output\lib\
          xcopy /E /I harbour\include output\include

      # --------------------------------------------------------------
      # 10. 生成时间戳
      # --------------------------------------------------------------
      - name: Generate timestamp
        id: timestamp
        shell: pwsh
        run: echo "date=$(Get-Date -Format yyyy_MM_dd)" >> $env:GITHUB_OUTPUT

      # --------------------------------------------------------------
      # 11. 上传 artifact
      # --------------------------------------------------------------
      - name: Upload Harbour artifact
        uses: actions/upload-artifact@v4
        with:
          name: harbour_win32_msvc_${{ steps.timestamp.outputs.date }}
          path: output/
          retention-days: 30
